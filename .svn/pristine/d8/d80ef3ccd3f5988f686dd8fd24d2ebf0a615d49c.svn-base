<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fr.eseo.ld.proseboard.mybatis.mappers.AuditReportMapper">

	<!-- Le type User est dÃ©fini dans fr.eseo.ld.proseboard.mybatis:config.xml -->
	<resultMap type="AuditReport" id="AuditReportResult">
		<id property="id" column="id_audit" />
		<result property="idTeam" column="id_team" />
		<result property="idAuditor" column="id_auditor" />
		<result property="note" column="note" />
		<result property="date" column="date" />
		<result property="report" column="report" />
		<result property="color1" column="color1" />
		<result property="color2" column="color2" />
		<result property="color3" column="color3" />
		<result property="finalColor" column="final_color" />
		<result property="percent" column="percent" />
		<result property="publicate" column="publicate" />
		
	</resultMap>
	
	
	
	<select id="getByIdAuditor" resultMap="AuditReportResult">
		SELECT * FROM audit JOIN status ON id_auditor = #{id}
	</select>
	
	<select id="getByIdTeam" resultMap="AuditReportResult">
		SELECT * FROM audit 
		WHERE id_team = #{id}
	</select>
	
	<select id="getIdTeamFromAudit" parameterType="Long" resultType="Long">
		SELECT audit.id_team FROM audit
		WHERE audit.id_audit = #{id}
		AND audit.publicate != 0
	</select>
	
	<select id="getDateFromAudit" parameterType="Long" resultType="String">
		SELECT audit.date FROM audit
		WHERE audit.id_audit = #{id}
	</select>
	
	<select id="getAuditTeamName" resultType="String">
		SELECT team.team_name FROM team 
		WHERE id_team = #{id}
	</select>
	
	<select id="getAuditTeamNameDistinct" resultType="String">
		SELECT DISTINCT team.team_name FROM team 
		WHERE id_team = #{id}
	</select>
	
	<select id="getIdSess" resultType="Long">
		SELECT  team.id_session FROM team 
		WHERE id_team = #{id}
	</select>
	
	<select id="getFinalColor" parameterType="Long" resultType="Long">
		SELECT  audit.final_color FROM audit 
		WHERE id_audit = #{id}
	</select>
	
	<select id="getMaxIdSess" resultType="Long">
		SELECT  MAX(session.id) FROM session 
	</select>
	
	<select id="getById" parameterType="Long" resultType="AuditReport">
		SELECT * FROM audit
		WHERE id_audit = #{id}
	</select>

	<select id="getAll" resultMap="AuditReportResult">
		SELECT * FROM audit
	</select>
	
	<select id="getAllOrderByDate" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.date DESC
	</select> 
	
	<select id="getAllOrderByEquipe" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.id_team ASC
	</select>
	
	<select id="getAllOrderByFond" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.color1 ASC
	</select>
	
	<select id="getAllOrderByForme" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.color2 ASC
	</select>
	
	<select id="getAllOrderByAttitude" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.color3 ASC
	</select>
	
	<select id="getAllOrderByCouleur" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.final_color ASC
	</select>
	
	<select id="getAllOrderByNote" resultMap="AuditReportResult">
		SELECT * FROM audit
		ORDER BY audit.note DESC
	</select>

	<insert id="insert" parameterType="AuditReport" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO audit (id_auditor, note, id_team, date, report, color1, color2, color3, final_color, comment, percent)
		VALUES(#{idAuditor}, #{note}, #{idTeam}, #{date}, #{report}, #{color1}, #{color2}, #{color3}, #{finalColor}, #{comment}, #{percent})
	</insert>
	
	<update id="publicate" parameterType="Long">
		UPDATE audit
		SET
		publicate = 1
		WHERE id_audit = #{id}
	</update>
	
	<update id="publicate2" parameterType="Long">
		UPDATE audit
		SET
		publicate = 2
		WHERE id_audit = #{id}
	</update>
	
	<update id="publicate3" parameterType="Long">
		UPDATE audit
		SET
		publicate = 3
		WHERE id_audit = #{id}
	</update>
	
	<update id="publicate4" parameterType="Long">
		UPDATE audit
		SET
		publicate = 4
		WHERE id_audit = #{id}
	</update>

	
	<update id="update" parameterType="AuditReport">
		UPDATE audit
		SET
		note = #{note},
		report = #{report},
		color1 = #{color1},
		color2 = #{color2},
		color3 = #{color3},
		final_color = #{finalColor},
		comment = #{comment}
		WHERE id_audit = #{id}
	</update>
	
	<delete id="deleteAuditsBySessionId" parameterType="long">
		DELETE a FROM audit a
		LEFT JOIN team t 
		ON a.id_team = t.id_team
		WHERE t.id_session = #{idSession}
	</delete>
	
	<select id="getAllByTeams" parameterType="map" resultMap="AuditReportResult">
   			SELECT * FROM audit WHERE audit.id_team IN 
    	<foreach collection="list" item="item" index="index" open="(" close=")" separator=", ">
    		#{list[${index}].id}
    	</foreach>
	</select>
	
	<select id="getAllByTeams2" parameterType="map" resultMap="AuditReportResult">
   			SELECT * FROM audit WHERE audit.id_team IN 
    	<foreach collection="list" item="item" index="index" open="(" close=")" separator=", ">
    		#{list[${index}]}
    	</foreach>
	</select>
	
</mapper>
